name: ADF CI/CD

on:
  push:
    branches:
      - collaboration

env:
  ADF_PUBLISH_BRANCH: adf_publish
  ARTIFACT_NAME: adf-arm-artifact.zip
  ARTIFACTORY_REPO: my-adf-local-repo

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write            # 用于 OIDC 到 Azure / JFrog（如果使用 OIDC）
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Fetch publish branch (adf_publish)
        run: |
          git fetch origin $ADF_PUBLISH_BRANCH:$ADF_PUBLISH_BRANCH || true
          git checkout $ADF_PUBLISH_BRANCH || true
        continue-on-error: true

      - name: Show ARM files
        run: ls -la

      - name: Validate JSON (basic)
        run: |
          npm install -g jsonlint
          jsonlint -q ./ARMTemplateForFactory.json || true

      - name: Zip ARM artifact
        run: |
          zip -r $ARTIFACT_NAME *.json

      # --- Upload to JFrog using JFrog CLI (example) ---
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v2
        with:
          version: '2.40.0'   # 可选

      - name: Configure JFrog (using env variables or OIDC)
        env:
          JFROG_URL: ${{ secrets.JFROG_URL }}
          JFROG_USERNAME: ${{ secrets.JFROG_USER }}
          JFROG_PASSWORD: ${{ secrets.JFROG_PASSWORD }}
        run: |
          jfrog config add myserver --url=$JFROG_URL --user=$JFROG_USERNAME --password=$JFROG_PASSWORD --interactive=false

      - name: Upload artifact to Artifactory
        run: |
          jfrog rt upload "$ARTIFACT_NAME" "$ARTIFACTORY_REPO/ADF/${{ github.sha }}/$ARTIFACT_NAME" --flat=true

      # --- Deploy to Azure via ARM deploy action ---
      - name: Login to Azure (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}     # 推荐使用 OIDC; 若用 SP, 需保密
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy ARM template
        uses: Azure/arm-deploy@v1
        with:
          scope: resourceGroup
          resourceGroupName: 'rg-adf-prod'
          template: './ARMTemplateForFactory.json'
          parameters: './ARMTemplateParametersForFactory.json'
